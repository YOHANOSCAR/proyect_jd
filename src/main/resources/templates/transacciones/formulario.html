<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Formulario de Transacción</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            // Inicializar Select2 para el buscador en el selector de productos
            $('.producto-select').select2({
                placeholder: "Seleccione un producto",
                allowClear: true
            });

            // Manejar el cambio de selección del producto
            $('.producto-select').on('change', function () {
                const precio = $(this).find(':selected').data('precio'); // Obtener el precio del producto
                const row = $(this).closest('.producto-row');
                row.find('.precio').val(precio || 0); // Mostrar el precio o 0 si no hay selección
                actualizarTotal();
            });

            // Función para actualizar el total dinámicamente
            function actualizarTotal() {
                let total = 0;
                $(".producto-row").each(function () {
                    const cantidad = $(this).find(".cantidad").val();
                    const precio = $(this).find(".precio").val();
                    const descuento = $(this).find(".descuento").val();
                    if (cantidad && precio) {
                        let subtotal = parseFloat(cantidad) * parseFloat(precio);
                        if (descuento) {
                            subtotal -= subtotal * (parseFloat(descuento) / 100);
                        }
                        total += subtotal;
                    }
                });
                $("#total").text(total.toFixed(2)); // Mostrar el total en el formulario
            }

            // Manejar los cambios en cantidad o descuento para actualizar el total
            $('.cantidad, .descuento').on('input', function () {
                actualizarTotal();
            });
        });
    </script>
</head>
<body>
<section layout:fragment="contenido">
    <div class="container mt-5">
        <h1>Formulario de Transacción</h1>
        <form th:action="@{/transacciones}" th:object="${transaccion}" method="post">
            <!-- Cliente -->
            <div class="mb-3">
                <label for="cliente" class="form-label">Cliente</label>
                <select id="cliente" name="cliente.id" class="form-select" required>
                    <option value="" disabled selected>Seleccione un cliente</option>
                    <option th:each="cliente : ${clientes}" th:value="${cliente.id}" th:text="${cliente.nombre}"></option>
                </select>
            </div>

            <!-- Tipo de Transacción -->
            <div class="mb-3">
                <label for="tipo" class="form-label">Tipo de Transacción</label>
                <select id="tipo" name="tipo" class="form-select" required>
                    <option value="" disabled selected>Seleccione un tipo</option>
                    <option th:each="tipo : ${tiposTransaccion}" th:value="${tipo}" th:text="${tipo}"></option>
                </select>
            </div>

            <!-- Productos -->
            <div class="mb-3">
                <label class="form-label">Productos</label>
                <div id="productos-container">
                    <div class="row mb-2 producto-row" th:each="producto : ${productos}">
                        <div class="col-md-4">
                            <select class="form-select producto-select" th:name="'productoId[' + ${producto.id} + ']'">
                                <option value="" disabled selected>Seleccione un producto</option>
                                <option th:each="producto : ${productos}"
                                        th:value="${producto.id}"
                                        th:text="${producto.nombre}"
                                        th:data-precio="${tipo == 'VENTA' ? producto.precioVenta : producto.costoAlquiler}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control precio" readonly placeholder="Precio Unitario" step="0.01">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control cantidad" th:name="'cantidades[' + ${producto.id} + ']'"
                                   placeholder="Cantidad" min="1">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control descuento" th:name="'descuentos[' + ${producto.id} + ']'"
                                   placeholder="Descuento (%)" step="0.01" min="0" max="100">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Método de Pago -->
            <div class="mb-3">
                <label for="metodoPago" class="form-label">Método de Pago</label>
                <select id="metodoPago" name="metodoPago" class="form-select" required>
                    <option value="" disabled selected>Seleccione un método de pago</option>
                    <option th:each="metodo : ${metodosPago}" th:value="${metodo}" th:text="${metodo}"></option>
                </select>
            </div>

            <!-- Notas -->
            <div class="mb-3">
                <label for="notas" class="form-label">Notas</label>
                <textarea id="notas" name="notas" class="form-control"></textarea>
            </div>

            <!-- Total -->
            <div class="mb-3">
                <label for="total" class="form-label">Total</label>
                <div id="total" class="form-text">0.00</div>
            </div>

            <!-- Botón Guardar -->
            <button type="submit" class="btn btn-primary">Guardar</button>
        </form>
    </div>
</section>
</body>
</html>
