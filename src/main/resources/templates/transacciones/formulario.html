<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout}">
<head>
    <title>Formulario de Transacción</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
</head>
<body>
<section layout:fragment="contenido">
    <div class="container mt-4">
        <h1>Registrar Transacción</h1>
        <form th:action="@{/transacciones}" method="post">
            <!-- Selección de Cliente -->
            <div class="mb-3">
                <label for="cliente" class="form-label">Cliente</label>
                <select id="cliente" name="clienteId" class="form-select" required>
                    <option value="" disabled selected>Seleccione un cliente</option>
                    <option th:each="cliente : ${clientes}" th:value="${cliente.id}" th:text="${cliente.nombre}"></option>
                </select>
            </div>

            <!-- Vendedor -->
            <div class="mb-3">
                <label for="vendedor" class="form-label">Vendedor</label>
                <input id="vendedor" type="text" th:value="${vendedorNombre}" class="form-control" readonly>
            </div>

            <!-- Tipo de Transacción -->
            <div class="mb-3">
                <label for="tipoTransaccion" class="form-label">Tipo de Transacción</label>
                <select id="tipoTransaccion" name="tipo" class="form-select" required>
                    <option value="" disabled selected>Seleccione el tipo de transacción</option>
                    <option th:each="tipo : ${tiposTransaccion}" th:value="${tipo}" th:text="${tipo}"></option>
                </select>
            </div>

            <!-- Método de Pago -->
            <div class="mb-3">
                <label for="metodoPago" class="form-label">Método de Pago</label>
                <select id="metodoPago" name="metodoPago" class="form-select" required>
                    <option value="" disabled selected>Seleccione un método de pago</option>
                    <option th:each="metodo : ${metodosPago}" th:value="${metodo}" th:text="${metodo}"></option>
                </select>
            </div>

            <!-- Productos Seleccionados -->
            <div class="mb-3">
                <label for="productosSeleccionados" class="form-label">Productos Seleccionados</label>
                <table class="table">
                    <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio Unitario</th>
                        <th>Cantidad</th>
                        <th>Descuento (%)</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody id="productosSeleccionados">
                    <!-- Los productos seleccionados se agregarán aquí dinámicamente -->
                    </tbody>
                </table>
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalProductos">Agregar Producto</button>
            </div>

            <!-- Inputs ocultos para mandar al backend -->
            <input type="hidden" id="productosIds" name="productoIds">
            <input type="hidden" id="cantidades" name="cantidades">
            <input type="hidden" id="precios" name="precios">
            <input type="hidden" id="descuentos" name="descuentos">

            <!-- Subtotal (cálculo front) -->
            <div class="mb-3">
                <label for="subtotal" class="form-label">Subtotal Calculado</label>
                <div id="subtotal" class="form-text">0.00</div>
            </div>

            <!-- Total (cálculo front) -->
            <div class="mb-3">
                <label for="total" class="form-label">Total Calculado</label>
                <div id="total" class="form-text">0.00</div>
            </div>

            <!-- Notas -->
            <div class="mb-3">
                <label for="notas" class="form-label">Notas</label>
                <textarea id="notas" name="notas" class="form-control"></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Guardar</button>
        </form>
    </div>

    <!-- Modal para Selección de Productos -->
    <div class="modal fade" id="modalProductos" tabindex="-1" aria-labelledby="modalProductosLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProductosLabel">Seleccionar Productos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <!-- Buscador (Opcional) -->
                    <input type="text" id="buscarProducto" class="form-control mb-3" placeholder="Buscar producto por nombre...">

                    <table class="table">
                        <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Precio Venta</th>
                            <th>Costo Alquiler</th>
                            <th>Cantidad Disponible</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody id="listaProductos">
                        <tr th:each="producto : ${productos}">
                            <td th:text="${producto.nombre}"></td>
                            <td th:text="${producto.precioVenta}"></td>
                            <td th:text="${producto.costoAlquiler}"></td>
                            <td th:text="${producto.cantidadDisponible}"></td>
                            <td>
                                <!-- Guardamos ambos precios para que el JS decida cuál usar -->
                                <button type="button" class="btn btn-success agregarProducto"
                                        th:data-id="${producto.id}"
                                        th:data-nombre="${producto.nombre}"
                                        th:data-precio-venta="${producto.precioVenta}"
                                        th:data-costo-alquiler="${producto.costoAlquiler}">
                                    Agregar
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tipoTransaccionSelect = document.getElementById('tipoTransaccion');
            const productosSeleccionados = document.getElementById('productosSeleccionados');
            const totalElement = document.getElementById('total');
            const subtotalElement = document.getElementById('subtotal');
            const productosIdsInput = document.getElementById('productosIds');
            const cantidadesInput = document.getElementById('cantidades');
            const preciosInput = document.getElementById('precios');
            const descuentosInput = document.getElementById('descuentos');
            const listaProductos = document.getElementById('listaProductos');
            const buscarProductoInput = document.getElementById('buscarProducto');

            // Agregar producto desde el modal
            listaProductos.addEventListener('click', function (event) {
                if (event.target.classList.contains('agregarProducto')) {
                    const id = event.target.getAttribute('data-id');
                    const nombre = event.target.getAttribute('data-nombre');
                    const precioVenta = parseFloat(event.target.getAttribute('data-precio-venta')) || 0;
                    const costoAlquiler = parseFloat(event.target.getAttribute('data-costo-alquiler')) || 0;

                    // Determinar qué precio usar según tipo de transacción
                    let precioSeleccionado = 0;
                    if (tipoTransaccionSelect.value === 'VENTA') {
                        precioSeleccionado = precioVenta;
                    } else if (tipoTransaccionSelect.value === 'ALQUILER') {
                        precioSeleccionado = costoAlquiler;
                    } else {
                        // Por si no se ha seleccionado un tipo aún
                        alert("Por favor, seleccione primero el tipo de transacción (VENTA o ALQUILER).");
                        return;
                    }

                    // Crear fila en la tabla de productosSeleccionados
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', id);
                    row.innerHTML = `
                        <td>${nombre}</td>
                        <td>${precioSeleccionado.toFixed(2)}</td>
                        <td><input type="number" class="form-control cantidad" value="1" min="1"></td>
                        <td><input type="number" class="form-control descuento" value="0" min="0" max="100"></td>
                        <td class="subtotal">${precioSeleccionado.toFixed(2)}</td>
                        <td><button type="button" class="btn btn-danger btn-sm eliminarProducto">Eliminar</button></td>
                    `;

                    // Agregar listeners para recálculo
                    const inputCantidad = row.querySelector('.cantidad');
                    const inputDescuento = row.querySelector('.descuento');

                    inputCantidad.addEventListener('input', actualizarTotal);
                    inputDescuento.addEventListener('input', actualizarTotal);

                    const btnEliminar = row.querySelector('.eliminarProducto');
                    btnEliminar.addEventListener('click', function () {
                        row.remove();
                        actualizarTotal();
                    });

                    productosSeleccionados.appendChild(row);
                    actualizarTotal();
                }
            });

            // Buscar producto en la lista (Opcional)
            buscarProductoInput.addEventListener('keyup', function () {
                const filtro = buscarProductoInput.value.toLowerCase();
                const filas = listaProductos.querySelectorAll('tr');
                filas.forEach(tr => {
                    const nombre = tr.querySelector('td:nth-child(1)').innerText.toLowerCase();
                    tr.style.display = nombre.includes(filtro) ? '' : 'none';
                });
            });

            // Función para recalcular totales
            function actualizarTotal() {
                let subtotalGeneral = 0;
                let total = 0;

                // Recorremos cada producto seleccionado
                productosSeleccionados.querySelectorAll('tr').forEach(row => {
                    const precioUnitario = parseFloat(row.querySelector('td:nth-child(2)').innerText) || 0;
                    const cantidad = parseFloat(row.querySelector('.cantidad').value) || 0;
                    const descuento = parseFloat(row.querySelector('.descuento').value) || 0;

                    // Subtotal previo al descuento
                    let sub = precioUnitario * cantidad;
                    subtotalGeneral += sub;

                    // Aplicamos descuento al subtotal
                    let montoDescuento = sub * (descuento / 100);
                    let subtotalConDescuento = sub - montoDescuento;

                    // Actualizar columna 'Subtotal'
                    const subtotalColumna = row.querySelector('.subtotal');
                    subtotalColumna.innerText = subtotalConDescuento.toFixed(2);

                    total += subtotalConDescuento;
                });

                subtotalElement.innerText = subtotalGeneral.toFixed(2);
                totalElement.innerText = total.toFixed(2);

                // Finalmente, actualizamos inputs ocultos
                actualizarInputsOcultos();
            }

            function actualizarInputsOcultos() {
                const productoIds = [];
                const cantidades = [];
                const precios = [];
                const descuentos = [];

                productosSeleccionados.querySelectorAll('tr').forEach(row => {
                    const id = row.getAttribute('data-id');
                    const precioUnitario = parseFloat(row.querySelector('td:nth-child(2)').innerText) || 0;
                    const cant = row.querySelector('.cantidad').value;
                    const desc = row.querySelector('.descuento').value;

                    productoIds.push(id);
                    cantidades.push(cant);
                    precios.push(precioUnitario.toFixed(2));
                    descuentos.push(desc);
                });

                productosIdsInput.value = productoIds.join(',');
                cantidadesInput.value = cantidades.join(',');
                preciosInput.value = precios.join(',');
                descuentosInput.value = descuentos.join(',');
            }
        });
    </script>
</section>
</body>
</html>
